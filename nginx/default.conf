# nginx/default.conf

# Bloco 1: Servidor HTTP para redirecionamento e desafio do Certbot
server {
    listen 80;
    # Escuta em ambos os domínios
    server_name forms.newnet.com.br pesquisa.newnet.com.br;

    # Rota especial para o Certbot provar que você é dono do domínio
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Para todas as outras requisições, redireciona para HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# Bloco 2: Servidor HTTPS para o Formulário (forms.newnet.com.br)
server {
    listen 443 ssl;
    server_name forms.newnet.com.br;

    ssl_certificate /etc/letsencrypt/live/forms.newnet.com.br/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/forms.newnet.com.br/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Rota para a API: qualquer requisição para forms.newnet.com.br/api/...
    # será repassada para o backend na porta 8000.
    location /api {
        proxy_pass http://api:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Rota principal: repassa todo o resto para o frontend do formulário.
    location / {
        proxy_pass http://form:3000; # 'form' é o nome do nosso serviço Next.js
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# Bloco 3: Servidor HTTPS para o Dashboard (pesquisa.newnet.com.br)
server {
    listen 443 ssl;
    server_name pesquisa.newnet.com.br;

    ssl_certificate /etc/letsencrypt/live/pesquisa.newnet.com.br/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/pesquisa.newnet.com.br/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Rota para a API: qualquer requisição para pesquisa.newnet.com.br/api/...
    # será repassada para o backend na porta 8000.
    location /api {
        proxy_pass http://api:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Rota principal: repassa todo o resto para o frontend do admin (Vite).
    location / {
        proxy_pass http://admin:80; # 'admin' é o nome do nosso serviço Vite/Nginx
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}